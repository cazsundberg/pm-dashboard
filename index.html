<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PM TL Deadline Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    label { margin-right: 8px; }
    input, button, select { margin: 4px; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; max-width: 1100px; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 12px; }
    th { background: #f3f3f3; }
    .status-done { background: #e0f7e9; }
    .status-missing { background: #ffe0e0; }
    .muted { color: #666; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>PM TL Deadline Dashboard</h1>

  <div>
    <label for="dateInput">TL Deadline date:</label>
    <input type="date" id="dateInput" />

    <label for="pmInput">PM:</label>
    <input type="text" id="pmInput" placeholder="(optional)" value="Caz" />

    <button id="loadDueBtn">Load due list</button>

    <button id="scanYesterdayBtn">Scan yesterday</button>
    <button id="scanSelectedBtn">Scan selected date</button>
    <button id="scanWeekendBtn">Scan weekend</button>
  </div>

  <div id="info" class="muted"></div>

  <table id="dueTable">
    <thead>
      <tr>
        <th>TLDeadline</th>
        <th>ProjectId</th>
        <th>ProjectName</th>
        <th>EpNo</th>
        <th>PM</th>
        <th>T Pressed?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby7jrwI9hUanx9EMZnguqjU14WkONUeYyqcqNDkalooCjQIn_i-wMTLYeI8vrvzDNSL/exec";
    const TMS_BASE   = "https://tms.kiledel.com/project/";
    const CONCURRENCY = 5;
    const POLL_TIMEOUT_MS = 45000;

    const dateInput = document.getElementById("dateInput");
    const pmInput   = document.getElementById("pmInput");
    const loadDueBtn = document.getElementById("loadDueBtn");
    const scanYesterdayBtn = document.getElementById("scanYesterdayBtn");
    const scanSelectedBtn  = document.getElementById("scanSelectedBtn");
    const scanWeekendBtn   = document.getElementById("scanWeekendBtn");
    const infoDiv    = document.getElementById("info");
    const dueTableBody = document.querySelector("#dueTable tbody");

    let currentDueRows = [];

    function toISODate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseISO(str) {
      // yyyy-mm-dd -> local date
      const [y, m, d] = str.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function setYesterdayDefault() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      dateInput.value = toISODate(d);
    }

    function makeScanId() {
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    async function fetchDueListFor(dateStr) {
      const pm = pmInput.value.trim();

      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", "dueList");
      url.searchParams.set("date", dateStr);
      if (pm) url.searchParams.set("pm", pm);

      const res = await fetch(url.toString());
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "dueList failed");
      return data.rows || [];
    }

    async function loadDueListUI() {
      const dateStr = dateInput.value;
      if (!dateStr) return alert("Please pick a date.");

      infoDiv.textContent = "Loading due list...";
      dueTableBody.innerHTML = "";
      currentDueRows = [];

      try {
        const rows = await fetchDueListFor(dateStr);
        currentDueRows = rows;
        infoDiv.textContent =
          `Found ${rows.length} episode(s) due on ${dateStr}` +
          (pmInput.value.trim() ? ` for PM ${pmInput.value.trim()}` : "");

        renderDueTable(rows, []);
      } catch (e) {
        infoDiv.textContent = "Error: " + e.toString();
      }
    }

    function renderDueTable(dueRows, scanRows) {
      const scanMap = {};
      scanRows.forEach(r => {
        const key = `${r.projectId}__${r.epNo}`;
        scanMap[key] = r;
      });

      dueTableBody.innerHTML = "";
      dueRows.forEach(row => {
        const key = `${row.projectId}__${row.epNo}`;
        const scan = scanMap[key];
        const tPressed = scan ? scan.tPressed : null;

        const tr = document.createElement("tr");
        if (tPressed === true) tr.classList.add("status-done");
        if (tPressed === false) tr.classList.add("status-missing");

        tr.innerHTML = `
          <td>${row.tlDeadline || ""}</td>
          <td>${row.projectId}</td>
          <td>${row.projectName}</td>
          <td>${row.epNo}</td>
          <td>${row.pm || ""}</td>
          <td>${tPressed === null ? "" : (tPressed ? "✔️" : "❌")}</td>
        `;
        dueTableBody.appendChild(tr);
      });
    }

    async function clearScanResultOnServer() {
      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", "clearScanResult");
      const res = await fetch(url.toString());
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "clearScanResult failed");
      return true;
    }

    async function fetchScanResults(scanId) {
  const url = new URL(WEBAPP_URL);
  url.searchParams.set("action", "scanResults");
  url.searchParams.set("scanId", scanId);   // <-- REQUIRED now
  const res = await fetch(url.toString());
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "Unknown error");
  return data.rows || [];
}

    function uniqueProjectIds(rows) {
      return Array.from(new Set(rows.map(r => String(r.projectId).trim()))).filter(Boolean);
    }

    function openScanTab(projectId, scanId) {
      const url = `${TMS_BASE}${projectId}?l=en_US&scan=1&scanId=${encodeURIComponent(scanId)}`;
      window.open(url, "_blank");
    }

    async function openTabsWithConcurrency(projectIds, scanId) {
      // Open in batches of CONCURRENCY
      for (let i = 0; i < projectIds.length; i += CONCURRENCY) {
        const batch = projectIds.slice(i, i + CONCURRENCY);
        batch.forEach(pid => openScanTab(pid, scanId));

        // Small pause so the browser doesn’t freak out
        await sleep(800);
      }
    }

    async function pollForResults(scanId, expectedProjectIds) {
      const start = Date.now();
      let lastRows = [];

      while (Date.now() - start < POLL_TIMEOUT_MS) {
        const rows = await fetchScanResults(scanId);
        lastRows = rows;

        const seenProjects = new Set(rows.map(r => String(r.projectId).trim()));
        const doneCount = expectedProjectIds.filter(pid => seenProjects.has(String(pid).trim())).length;

        infoDiv.textContent = `Scanning... got results from ${doneCount}/${expectedProjectIds.length} project(s).`;

        if (doneCount >= expectedProjectIds.length) return rows;
        await sleep(1200);
      }

      infoDiv.textContent = `Timed out after ${Math.round(POLL_TIMEOUT_MS/1000)}s. Showing partial results.`;
      return lastRows;
    }

    async function runScanForRows(dueRows, labelForInfo) {
      if (!dueRows.length) {
        infoDiv.textContent = `No due rows for ${labelForInfo}.`;
        renderDueTable(dueRows, []);
        return;
      }

      const scanId = makeScanId();
      const projectIds = uniqueProjectIds(dueRows);

      infoDiv.textContent = "Clearing previous scan results...";
      await clearScanResultOnServer();

      infoDiv.textContent = `Opening ${projectIds.length} project tab(s) (cap ${CONCURRENCY} at a time)...`;
      await openTabsWithConcurrency(projectIds, scanId);

      // Give tabs a moment to start posting
      await sleep(1500);

      const scanRows = await pollForResults(scanId, projectIds);
      infoDiv.textContent = `Scan complete: received ${scanRows.length} row(s).`;
      renderDueTable(dueRows, scanRows);
    }

    // Weekend logic: find the weekend (Sat+Sun) immediately before/including selected date
    function getWeekendDatesFromSelected(selectedISO) {
      const d = parseISO(selectedISO);
      const day = d.getDay(); // Sun=0 ... Sat=6

      // Find Saturday of that weekend
      // If selected is Sat (6): sat = today
      // If selected is Sun (0): sat = yesterday
      // Else (Mon-Fri): sat = previous Saturday
      const sat = new Date(d);
      if (day === 6) sat.setDate(d.getDate());
      else if (day === 0) sat.setDate(d.getDate() - 1);
      else sat.setDate(d.getDate() - (day + 1));

      const sun = new Date(sat);
      sun.setDate(sat.getDate() + 1);

      return { satISO: toISODate(sat), sunISO: toISODate(sun) };
    }

    // Button handlers
    loadDueBtn.addEventListener("click", loadDueListUI);

    scanYesterdayBtn.addEventListener("click", async () => {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      const iso = toISODate(d);
      dateInput.value = iso;

      try {
        infoDiv.textContent = "Loading due list for yesterday...";
        const rows = await fetchDueListFor(iso);
        currentDueRows = rows;
        renderDueTable(rows, []);
        await runScanForRows(rows, `yesterday (${iso})`);
      } catch (e) {
        infoDiv.textContent = "Error: " + e.toString();
      }
    });

    scanSelectedBtn.addEventListener("click", async () => {
      const iso = dateInput.value;
      if (!iso) return alert("Pick a date first.");

      try {
        infoDiv.textContent = "Loading due list for selected date...";
        const rows = await fetchDueListFor(iso);
        currentDueRows = rows;
        renderDueTable(rows, []);
        await runScanForRows(rows, `selected date (${iso})`);
      } catch (e) {
        infoDiv.textContent = "Error: " + e.toString();
      }
    });

    scanWeekendBtn.addEventListener("click", async () => {
      const base = dateInput.value;
      if (!base) return alert("Pick a date first.");

      try {
        const { satISO, sunISO } = getWeekendDatesFromSelected(base);
        infoDiv.textContent = `Loading weekend due lists (${satISO} + ${sunISO})...`;

        const satRows = await fetchDueListFor(satISO);
        const sunRows = await fetchDueListFor(sunISO);

        // merge
        const merged = [...satRows, ...sunRows];
        currentDueRows = merged;

        renderDueTable(merged, []);
        await runScanForRows(merged, `weekend (${satISO} + ${sunISO})`);
      } catch (e) {
        infoDiv.textContent = "Error: " + e.toString();
      }
    });

    setYesterdayDefault();
  </script>
</body>
</html>
