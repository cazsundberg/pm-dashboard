<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PM TL Deadline Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    label { margin-right: 8px; }
    input, button, select { margin: 4px; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; max-width: 1000px; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 12px; }
    th { background: #f3f3f3; }
    .status-done { background: #e0f7e9; }
    .status-missing { background: #ffe0e0; }
  </style>
</head>
<body>
  <h1>PM TL Deadline Dashboard</h1>

  <div>
    <label for="dateInput">TL Deadline date:</label>
    <input type="date" id="dateInput" />

    <label for="pmInput">PM:</label>
    <input type="text" id="pmInput" placeholder="(optional)" value="Caz" />

    <button id="loadDueBtn">Load due list</button>
    <button id="scanBtn" disabled>Scan & Refresh</button>
  </div>

  <div id="info"></div>

  <table id="dueTable">
    <thead>
      <tr>
        <th>ProjectId</th>
        <th>ProjectName</th>
        <th>EpNo</th>
        <th>PM</th>
        <th>TLDeadline</th>
        <th>T Pressed?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // TODO: paste your Web App URL here:
    const WEBAPP_URL = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec";
    const TMS_BASE   = "https://tms.kiledel.com/project/";

    const dateInput = document.getElementById("dateInput");
    const pmInput   = document.getElementById("pmInput");
    const loadDueBtn = document.getElementById("loadDueBtn");
    const scanBtn    = document.getElementById("scanBtn");
    const infoDiv    = document.getElementById("info");
    const dueTableBody = document.querySelector("#dueTable tbody");

    // Store the last due list in memory so we can merge scan results
    let currentDueRows = [];

    function setYesterdayDefault() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      dateInput.value = `${y}-${m}-${day}`;
    }

    async function fetchDueList() {
      const dateStr = dateInput.value;
      const pm = pmInput.value.trim();

      if (!dateStr) {
        alert("Please pick a date.");
        return;
      }

      infoDiv.textContent = "Loading due list...";
      dueTableBody.innerHTML = "";
      scanBtn.disabled = true;
      currentDueRows = [];

      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", "dueList");
      url.searchParams.set("date", dateStr);
      if (pm) url.searchParams.set("pm", pm);

      const res = await fetch(url.toString());
      const data = await res.json();

      if (!data.ok) {
        infoDiv.textContent = "Error loading due list: " + (data.error || "Unknown error");
        return;
      }

      currentDueRows = data.rows || [];
      infoDiv.textContent = `Found ${currentDueRows.length} episode(s) due on ${dateStr}` +
        (pm ? ` for PM ${pm}` : "");

      renderDueTable(currentDueRows, []); // no scan results yet
      scanBtn.disabled = !currentDueRows.length;
    }

    function renderDueTable(dueRows, scanRows) {
      // Build quick lookup for scan results: key = projectId + '__' + epNo
      const scanMap = {};
      scanRows.forEach(r => {
        const key = `${r.projectId}__${r.epNo}`;
        scanMap[key] = r;
      });

      dueTableBody.innerHTML = "";

      dueRows.forEach(row => {
        const key = `${row.projectId}__${row.epNo}`;
        const scan = scanMap[key];
        const tPressed = scan ? scan.tPressed : null;

        const tr = document.createElement("tr");
        if (tPressed === true) tr.classList.add("status-done");
        if (tPressed === false) tr.classList.add("status-missing");

        tr.innerHTML = `
          <td>${row.projectId}</td>
          <td>${row.projectName}</td>
          <td>${row.epNo}</td>
          <td>${row.pm || ""}</td>
          <td>${row.tlDeadline || ""}</td>
          <td>${tPressed === null ? "" : (tPressed ? "✔️" : "❌")}</td>
        `;

        dueTableBody.appendChild(tr);
      });
    }

    async function clearScanResultOnServer() {
      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", "clearScanResult");
      const res = await fetch(url.toString());
      const data = await res.json();
      return data.ok;
    }

    function openScanTabsForDueRows(dueRows) {
      const projectIds = Array.from(new Set(dueRows.map(r => r.projectId)));
      projectIds.forEach(pid => {
        const url = `${TMS_BASE}${pid}?l=en_US&scan=1`;
        window.open(url, "_blank");
      });
    }

    async function fetchScanResults() {
      const url = new URL(WEBAPP_URL);
      url.searchParams.set("action", "scanResults");
      const res = await fetch(url.toString());
      const data = await res.json();
      if (!data.ok) {
        throw new Error(data.error || "Unknown error");
      }
      return data.rows || [];
    }

    async function runScan() {
      if (!currentDueRows.length) {
        alert("No due rows loaded.");
        return;
      }

      infoDiv.textContent = "Clearing previous scan results...";
      scanBtn.disabled = true;

      const cleared = await clearScanResultOnServer();
      if (!cleared) {
        infoDiv.textContent = "Failed to clear previous scan results.";
        scanBtn.disabled = false;
        return;
      }

      infoDiv.textContent = "Opening TMS tabs to scan...";
      openScanTabsForDueRows(currentDueRows);

      // Give the tabs some time to load and send snapshots
      // You can tweak this delay.
      setTimeout(async () => {
        infoDiv.textContent = "Fetching scan results...";
        try {
          const scanRows = await fetchScanResults();
          infoDiv.textContent = `Scan complete: ${scanRows.length} snapshot row(s) received.`;
          renderDueTable(currentDueRows, scanRows);
        } catch (err) {
          console.error(err);
          infoDiv.textContent = "Error fetching scan results: " + err.toString();
        } finally {
          scanBtn.disabled = false;
        }
      }, 8000); // 8 seconds delay for safety
    }

    loadDueBtn.addEventListener("click", fetchDueList);
    scanBtn.addEventListener("click", runScan);

    setYesterdayDefault();
  </script>
</body>
</html>
